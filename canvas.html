<html>
    <head>
	<title>Canvas</title>
	<script
	    src="https://code.jquery.com/jquery-3.2.1.min.js"
	    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
	    crossorigin="anonymous"></script>
	<script type="text/javascript">
	 var bucket_size = 1000 * 5;
	 var stroke_buckets = {};
	 var strokes = [];
	 var active_stroke = null;
	 var active_bucket = null;
	 var recording = true;
	 var playing = false;
	 var last_project_time = 0;
	 var last_real_time = 0;
	 var last_draw = null;
	 var current_project_time = 0;
	 var current_seq_id = 0;

	 function getMousePos(canvas, evt) {
	     var rect = canvas.getBoundingClientRect();
	     return {
		 x: evt.clientX - rect.left,
		 y: evt.clientY - rect.top
	     };
	 }

	 function clear(ctx) {
	     ctx.clearRect(0, 0, 720, 1280);
	     ctx.fillStyle = "#FAF7F8";
	     ctx.beginPath();
	     ctx.rect(0, 0, 720, 1280);
	     ctx.closePath();
	     ctx.fill();
	 }
	 
	 function compare_strokes(a, b) {
	     if (a.time < b.time) {
		 return -1;
	     } else if (a.time > b.time) {
		 return 1;
	     } else if (a.seq_id < b.seq_id) {
		 return -1;
	     } else if (a.seq_id > b.seq_id) {
		 return 1;
	     } else {
		 return 0;
	     }
	 }
	 
	 function sort_strokes(bucket) {
	     var all_strokes = [];
	     var i, j;
	     for (i = 0; i < bucket.length; i++) {
		 var stroke = bucket[i];
		 for (j = 1; j < stroke.pnts.length; j++) {
		     all_strokes.push({
			 start: stroke.pnts[j-1],
			 end: stroke.pnts[j],
			 time: stroke.start + stroke.pnts[j].time,
			 seq_id: stroke.pnts[j].seq_id,
		     });
		 }
	     }
	     all_strokes.sort(compare_strokes);
	     return all_strokes;
	 }
	 
	 function drawPeriod(ctx, start, end) {
	     var i, j, bucket;
	     if (typeof start == "number") {
		 start = {
		     time: start,
		     seq_id: 0,
		 };
	     }
	     if (typeof end == "number") {
		 end = {
		     time: end,
		     seq_id: Infinity,
		 };
	     }
	     var start_bucket = Math.floor(start.time / bucket_size);
	     var end_bucket = Math.floor(end.time / bucket_size);
	     for (bucket = start_bucket; bucket <= end_bucket; bucket++) {
		 if (!(bucket in stroke_buckets)) {
		     continue;
		 }
		 var sorted_strokes = sort_strokes(stroke_buckets[bucket]);
		 for (i = 0; i < sorted_strokes.length; i++) {
		     var stroke = sorted_strokes[i];
		     if (compare_strokes(stroke, start) >= 0 && compare_strokes(stroke, end) <= 0) {
			 ctx.beginPath();
			 ctx.moveTo(stroke.start.x, stroke.start.y);
			 ctx.lineTo(stroke.end.x, stroke.end.y);
			 ctx.stroke();
		     }
		 }
	     }
	 }
	 
	 function tick() {
	     set_current_project_time();
	     draw();
	     if (playing) {
		 $("#time").val(current_project_time / 1000);
	     }
	     window.requestAnimationFrame(tick);
	 }
	 
	 var always_clear = false;
	 
	 function draw() {
	     var layer1 = $("#layer-1").get(0);
	     var ctx1 = layer1.getContext("2d");
	     var now = {
		 time: current_project_time,
		 seq_id: current_seq_id,
	     };
	     if (always_clear || compare_strokes(now, last_draw) < 0) {
		 console.log("CLEAR");
		 clear(ctx1);
		 drawPeriod(ctx1, 0, now);
	     } else {
		 drawPeriod(ctx1, last_draw, now);
	     }
	     last_draw = now;
	 }
	 
	 function set_current_project_time() {
	     current_project_time = last_project_time;
	     if (playing) {
		 var now = new Date();
		 var delta = now.getTime() - last_real_time;
		 current_project_time += delta;
	     }
	 }
	 
	 function mousemove(event) {
	     if (recording && !(active_stroke === null)) {
		 var project_time = current_project_time;
		 var bucket = Math.floor(project_time / bucket_size);
		 var pos = getMousePos($("#layer-1").get(0), event);
		 var pnt = {
		     x: pos.x,
		     y: pos.y,
		     time: project_time - active_stroke.start,
		     seq_id: current_seq_id++,
		 };
		 active_stroke.pnts.push(pnt);
		 if (bucket != active_bucket) {
		     if (!(bucket in stroke_buckets)) {
			 stroke_buckets[bucket] = [];
		     }
		     stroke_buckets[bucket].push(active_stroke);
		     active_bucket = bucket;
		 }
	     }
	 }

	 function mousedown(event) {
	     if (recording && (active_stroke === null)) {
		 var pos = getMousePos($("#layer-1").get(0), event);
		 var start_time = current_project_time;
		 active_stroke = {
		     start: start_time,
		     pnts: [{
			 x: pos.x,
			 y: pos.y,
			 time: 0,
			 seq_id: current_seq_id++,
		     }],
		 };
		 strokes.push(active_stroke);
		 active_bucket = Math.floor(start_time / bucket_size);
		 if (!(active_bucket in stroke_buckets)) {
		     stroke_buckets[active_bucket] = [];
		 }
		 stroke_buckets[active_bucket].push(active_stroke);
	     }
	 }

	 function mouseup(event) {
	     if (recording && !(active_stroke === null)) {
		 active_stroke = null;
		 active_bucket = null;
	     }
	 }

	 function play() {
	     if (!playing) {
		 var now = new Date();
		 last_real_time = now.getTime();
		 playing = true;
	     }
	 }

	 function stop() {
	     if (playing) {
		 set_current_project_time();
		 last_project_time = current_project_time;
		 playing = false;
	     }
	 }

	 function go() {
	     if (!playing) {
		 var time = 1000*parseFloat($("#time").val());
		 if (!isNaN(time)) {
		     last_project_time = time;
		 }
		 $("#time").val(last_project_time / 1000);
	     }
	 }
	 
	 $(document).ready(function () {
	     last_project_time = 0;
	     last_draw = {
		 time: 100,
		 seq_id: 0,
	     }; /* HACK */
	     
	     var now = new Date();
	     last_real_time = now.getTime();

	     $("#layer-1").on("mousemove", mousemove);
	     $("#layer-1").on("mouseup", mouseup);
	     $("#layer-1").on("mousedown", mousedown);

	     $("#play").on("click", play);
	     $("#stop").on("click", stop);
	     $("#go").on("click", go);

	     window.requestAnimationFrame(tick);
	 });
	</script>
    </head>
    <body>
	<p>Hello there!</p>
	<p>Time:
	    <input type="text" id="time"/>
	    <button type="button" id="go">Go</button>
	</p>
	<p>
	    <button type="button" id="play">Play</button>
	    <button type="button" id="stop">Stop</button>
	</p>
	<canvas id="layer-1" height="1280px" width="720px">
	    Browser doesn't support canvas! Oops!
	</canvas>
    </body>
</html>
