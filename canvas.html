<html>
    <head>
	<title>Canvas</title>
	<script
	    src="https://code.jquery.com/jquery-3.2.1.min.js"
	    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
	    crossorigin="anonymous"></script>
	<script type="text/javascript">
	 var bucket_size = 1000 * 5;
	 var strokes = {};
	 var active_stroke = null;
	 var recording = true;
	 var playing = false;
	 var last_project_time = 0;
	 var last_real_time = 0;
	 var last_draw_time = 0;
	 var current_project_time = 0;
	 var current_cache = 0;

	 function getMousePos(canvas, evt) {
	     var rect = canvas.getBoundingClientRect();
	     return {
		 x: evt.clientX - rect.left,
		 y: evt.clientY - rect.top
	     };
	 }

	 function clear(ctx) {
	     ctx.clearRect(0, 0, 720, 1280);
	     ctx.fillStyle = "#FAF7F8";
	     ctx.beginPath();
	     ctx.rect(0, 0, 720, 1280);
	     ctx.closePath();
	     ctx.fill();
	 }
	 
	 function compare_strokes(a, b) {
	     if (a.time < b.time) {
		 return -1;
	     } else if (a.time > b.time) {
		 return 1;
	     } else {
		 return 0;
	     }
	 }
	 
	 function sort_strokes(bucket) {
	     var all_strokes = [];
	     var i, j;
	     for (i = 0; i < bucket.length; i++) {
		 var stroke = bucket[i];
		 var last = stroke.pnts[0];
		 for (j = 1; j < stroke.pnts.length; j++) {
		     all_strokes.push({
			 start: last,
			 end: stroke.pnts[j],
			 time: stroke.start + stroke.pnts[j].time,
		     });
		     last = stroke.pnts[j];
		 }
	     }
	     all_strokes.sort(compare_strokes);
	     return all_strokes;
	 }
	 
	 var first = true;
	 
	 function drawPeriod(ctx, start, end, cache) {
	     var i, j, bucket;
	     var start_bucket = Math.floor(start / bucket_size);
	     var end_bucket = Math.floor(end / bucket_size);
	     for (bucket = start_bucket; bucket <= end_bucket; bucket++) {
		 if (!(bucket in strokes)) {
		     continue;
		 }
		 var sorted_strokes = sort_strokes(strokes[bucket]);
		 if (first) {
		     console.log(sorted_strokes);
		     first = false;
		 }
		 for (i = 0; i < sorted_strokes.length; i++) {
		     var stroke = sorted_strokes[i];
		     if (stroke.time >= start && stroke.time <= end) {
			 if (stroke.time != start || cache === null || stroke.end.cache !== cache) {
			     ctx.beginPath();
			     ctx.moveTo(stroke.start.x, stroke.start.y);
			     ctx.lineTo(stroke.end.x, stroke.end.y);
			     ctx.stroke();
			     if (cache !== null) {
				 stroke.end.cache = cache;
			     }
			 }
		     }
		 }
	     }
	 }
	 
	 function tick() {
	     set_current_project_time();
	     //console.log(current_project_time);
	     draw();
	     if (playing) {
		 $("#time").val(current_project_time / 1000);
	     }
	     window.requestAnimationFrame(tick);
	 }
	 
	 var always_clear = false;
	 
	 function draw() {
	     var layer1 = $("#layer-1").get(0);
	     var ctx1 = layer1.getContext("2d");
	     var time = current_project_time;
	     if (always_clear || time < last_draw_time) {
		 console.log("CLEAR");
		 clear(ctx1);
		 current_cache++;
		 drawPeriod(ctx1, 0, time, current_cache);
	     } else {
		 drawPeriod(ctx1, last_draw_time, time, current_cache);
	     }
	     last_draw_time = time;
	 }
	 
	 function set_current_project_time() {
	     current_project_time = last_project_time;
	     if (playing) {
		 var now = new Date();
		 var delta = now.getTime() - last_real_time;
		 current_project_time += delta;
	     }
	 }
	 
	 function mousemove(event) {
	     if (recording && !(active_stroke === null)) {
		 var project_time = current_project_time;
		 var bucket = Math.floor(project_time / bucket_size);
		 var start_bucket = Math.floor(active_stroke.start / bucket_size);
		 var pos = getMousePos($("#layer-1").get(0), event);
		 if (bucket != start_bucket) {
		     next_stroke = {
			 start: bucket * bucket_size,
			 pnts: [],
			 first: active_stroke.first,
			 next: null,
		     };
		     next_stroke.pnts.push({
			 x: active_stroke.pnts[active_stroke.pnts.length-1].x,
			 y: active_stroke.pnts[active_stroke.pnts.length-1].y,
			 time: 0,
		     });
		     active_stroke.next = next_stroke;
		     active_stroke = next_stroke;
		     if (!(bucket in strokes)) {
			 strokes[bucket] = [];
		     }
		     strokes[bucket].push(active_stroke);
		 }
		 var pnt = {
		     x: pos.x,
		     y: pos.y,
		     time: project_time - active_stroke.start,
		 };
		 active_stroke.pnts.push(pnt);
	     }
	 }

	 function mousedown(event) {
	     if (recording && (active_stroke === null)) {
		 var pos = getMousePos($("#layer-1").get(0), event);
		 var start_time = current_project_time;
		 active_stroke = {
		     start: start_time,
		     pnts: [],
		     first: null,
		     next: null,
		 };
		 active_stroke.first = active_stroke;
		 var pnt = {
		     x: pos.x,
		     y: pos.y,
		     time: 0,
		 };
		 var bucket = Math.floor(start_time / bucket_size);
		 active_stroke.pnts.push(pnt);
		 if (!(bucket in strokes)) {
		     strokes[bucket] = [];
		 }
		 strokes[bucket].push(active_stroke);
	     }
	 }

	 function mouseup(event) {
	     if (recording && !(active_stroke === null)) {
		 active_stroke = null;
	     }
	 }

	 function play() {
	     var now = new Date();
	     last_real_time = now.getTime();
	     playing = true;
	 }

	 function stop() {
	     set_current_project_time();
	     last_project_time = current_project_time;
	     playing = false;
	 }
	 
	 $(document).ready(function () {
	     last_project_time = 0;
	     last_draw_time = 100; /* HACK */
	     
	     var now = new Date();
	     last_real_time = now.getTime();

	     $("#layer-1").on("mousemove", mousemove);
	     $("#layer-1").on("mouseup", mouseup);
	     $("#layer-1").on("mousedown", mousedown);

	     window.requestAnimationFrame(tick);
	 });
	</script>
    </head>
    <body>
	<p>Hello there!</p>
	<canvas id="layer-1" height="1280px" width="720px">
	    Browser doesn't support canvas! Oops!
	</canvas>
    </body>
</html>
